From 4ea8ba3c69beabf1925516553aee55bcce3843dd Mon Sep 17 00:00:00 2001
From: Shane Freeder <theboyetronic@gmail.com>
Date: Mon, 6 Feb 2017 17:04:36 +0000
Subject: [PATCH] Patch to pick up random NBT parsing errors - paper 1.11.2


diff --git a/src/main/java/net/minecraft/server/RegionFile.java b/src/main/java/net/minecraft/server/RegionFile.java
index 4008a2143..74ada1184 100644
--- a/src/main/java/net/minecraft/server/RegionFile.java
+++ b/src/main/java/net/minecraft/server/RegionFile.java
@@ -264,6 +264,10 @@ public class RegionFile {
 
     }
 
+    public File getFile() {
+        return b;
+    }
+
     class ChunkBuffer extends ByteArrayOutputStream {
 
         private final int b;
diff --git a/src/main/java/net/minecraft/server/RegionFileCache.java b/src/main/java/net/minecraft/server/RegionFileCache.java
index 91b55074e..95e5eaa87 100644
--- a/src/main/java/net/minecraft/server/RegionFileCache.java
+++ b/src/main/java/net/minecraft/server/RegionFileCache.java
@@ -2,17 +2,15 @@ package net.minecraft.server;
 
 import com.destroystokyo.paper.exception.ServerInternalException;
 import com.google.common.collect.Maps;
-import java.io.DataInputStream;
-import java.io.DataOutputStream;
-import java.io.File;
-import java.io.IOException;
+
+import java.io.*;
+import java.lang.reflect.Field;
 import java.util.Iterator;
 import java.util.Map;
 import com.destroystokyo.paper.PaperConfig; // Paper
 import java.util.LinkedHashMap; // Paper
 
 public class RegionFileCache {
-
     public static final Map<File, RegionFile> a = new LinkedHashMap(PaperConfig.regionFileCacheSize, 0.75f, true); // Spigot - private -> public, Paper - HashMap -> LinkedHashMap
 
     public static synchronized RegionFile a(File file, int i, int j) {
@@ -104,7 +102,15 @@ public class RegionFileCache {
             return null;
         }
 
-        return NBTCompressedStreamTools.a(datainputstream);
+        try {
+            return NBTCompressedStreamTools.a(datainputstream);
+        } catch (Exception ex){
+            System.out.println("Crash Info: " + file.getName() + " i: " + i + " j: " + j);
+            System.out.println("Crash Info: " + file.getName() + " i2: " + (i & 31) + " j2: " + (j & 31));
+            System.out.println("Crash Info: File: " + regionfile.getFile().getAbsolutePath());
+
+            throw ex;
+        }
     }
 
     public static synchronized void e(File file, int i, int j, NBTTagCompound nbttagcompound) throws IOException {
-- 
2.12.2

