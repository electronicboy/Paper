From 43bcf944f294cb3c2ce3aa500e73c1df3adf4c93 Mon Sep 17 00:00:00 2001
From: BillyGalbreath <Blake.Galbreath@GMail.com>
Date: Sun, 7 May 2017 06:26:09 -0500
Subject: [PATCH] EntityPickupItemEvent#setFlyAtEntity

PlayerPickupItemEvent#setFlyAtPlayer - support retained for backwards interop

diff --git a/src/main/java/net/minecraft/server/EntityInsentient.java b/src/main/java/net/minecraft/server/EntityInsentient.java
index 89e878365..19e694fce 100644
--- a/src/main/java/net/minecraft/server/EntityInsentient.java
+++ b/src/main/java/net/minecraft/server/EntityInsentient.java
@@ -610,7 +610,11 @@ public abstract class EntityInsentient extends EntityLiving {
             }
 
             this.persistent = true;
-            this.receive(entityitem, itemstack.getCount());
+            // Paper start
+            if (entityEvent.getFlyAtEntity()) {
+                this.receive(entityitem, itemstack.getCount());
+            }
+            // Paper end
             entityitem.die();
         }
 
diff --git a/src/main/java/net/minecraft/server/EntityItem.java b/src/main/java/net/minecraft/server/EntityItem.java
index 99dbb1393..9dcc800c5 100644
--- a/src/main/java/net/minecraft/server/EntityItem.java
+++ b/src/main/java/net/minecraft/server/EntityItem.java
@@ -332,6 +332,7 @@ public class EntityItem extends Entity implements HopperPusher {
             // CraftBukkit start - fire PlayerPickupItemEvent
             int canHold = entityhuman.inventory.canHold(itemstack);
             int remaining = i - canHold;
+            boolean flyAtEntity = false; // Paper
 
             if (this.pickupDelay <= 0 && canHold > 0) {
                 itemstack.setCount(canHold);
@@ -339,14 +340,22 @@ public class EntityItem extends Entity implements HopperPusher {
                 PlayerPickupItemEvent playerEvent = new PlayerPickupItemEvent((org.bukkit.entity.Player) entityhuman.getBukkitEntity(), (org.bukkit.entity.Item) this.getBukkitEntity(), remaining);
                 playerEvent.setCancelled(!entityhuman.canPickUpLoot);
                 this.world.getServer().getPluginManager().callEvent(playerEvent);
+                flyAtEntity = playerEvent.getFlyAtPlayer(); // Paper
                 if (playerEvent.isCancelled()) {
+                    // Paper Start
+                    if (flyAtEntity) {
+                        entityhuman.receive(this, i);
+                    }
+                    // Paper End
                     return;
                 }
 
                 // Call newer event afterwards
                 EntityPickupItemEvent entityEvent = new EntityPickupItemEvent((org.bukkit.entity.Player) entityhuman.getBukkitEntity(), (org.bukkit.entity.Item) this.getBukkitEntity(), remaining);
                 entityEvent.setCancelled(!entityhuman.canPickUpLoot);
+                entityEvent.setFlyAtEntity(flyAtEntity); // Paper - pass through flag inside PlayerPickupItemEvent in order to provide backwards support
                 this.world.getServer().getPluginManager().callEvent(entityEvent);
+                flyAtEntity = entityEvent.getFlyAtEntity(); // Paper
                 if (entityEvent.isCancelled()) {
                     return;
                 }
@@ -359,7 +368,11 @@ public class EntityItem extends Entity implements HopperPusher {
             // CraftBukkit end
 
             if (this.pickupDelay == 0 && (this.h == null || 6000 - this.age <= 200 || this.h.equals(entityhuman.getName())) && entityhuman.inventory.pickup(itemstack)) {
-                entityhuman.receive(this, i);
+                // Paper Start
+                if (flyAtEntity) {
+                    entityhuman.receive(this, i);
+                }
+                // Paper End
                 if (itemstack.isEmpty()) {
                     this.die();
                     itemstack.setCount(i);
-- 
2.13.3

